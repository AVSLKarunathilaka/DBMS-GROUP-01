DELIMITER //

CREATE TRIGGER BeforeInsertMark
BEFORE INSERT ON Mark
FOR EACH ROW
BEGIN
    DECLARE v_course_code VARCHAR(10);
    DECLARE v_enrollment_count INT;

    -- Find course code from assessment component
    SELECT course_code INTO v_course_code
    FROM AssessmentComponent
    WHERE assessment_id = NEW.assessment_id;

    -- Check if student is enrolled for that course
    SELECT COUNT(*) INTO v_enrollment_count
    FROM Enrollment
    WHERE student_id = NEW.student_id
      AND course_code = v_course_code;

    -- If not enrolled, stop insertion
    IF v_enrollment_count = 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: Student is not enrolled in this course.';
    END IF;
END;
//

DELIMITER ;
