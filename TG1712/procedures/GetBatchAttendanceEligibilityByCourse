DELIMITER //

CREATE PROCEDURE GetBatchAttendanceEligibilityByCourse(IN p_course_code VARCHAR(10))
BEGIN
    SELECT
        s.registration_no,
        se.course_code,
        ROUND(
            (SUM(CASE WHEN a.status = 'present' THEN 1 ELSE 0 END) * 100.0) / COUNT(a.session_id),
            2
        ) AS attendance_percentage,
        CASE 
            WHEN ROUND(
                (SUM(CASE WHEN a.status = 'present' THEN 1 ELSE 0 END) * 100.0) / COUNT(a.session_id),
                2
            ) >= 80 THEN 'Eligible'
            ELSE 'Not Eligible'
        END AS eligibility_status
    FROM Attendance a
    JOIN Session se ON a.session_id = se.session_id
    JOIN Student s ON a.student_id = s.user_id
    WHERE se.course_code = p_course_code
      AND s.status NOT IN ('repeat', 'suspended')
    GROUP BY s.registration_no, se.course_code
    ORDER BY s.registration_no;
END //

DELIMITER ;
