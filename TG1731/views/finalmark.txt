CREATE OR REPLACE VIEW final_mark AS
SELECT
    s.registration_no,
    c.course_code,
    
    CASE
        WHEN s.status = 'suspended' THEN 0
        ELSE ROUND(COALESCE(c.ca_total, 0) + COALESCE(e.end_total, 0), 2)
    END AS final_total,

    
    CASE
        WHEN s.status = 'suspended' THEN 'Suspended'
        WHEN s.status = 'repeat' THEN 'Repeat'
        WHEN COALESCE(c.ca_total, 0) < 20 THEN 'CA Fail'
        WHEN COALESCE(e.end_total, 0) = 0 THEN 'End Fail'
        ELSE 'Eligible'
    END AS reason

FROM CAView c
JOIN Student s 
    ON c.student_id = s.user_id
LEFT JOIN EndMarkView e 
    ON c.student_id = e.student_id
   AND c.course_code = e.course_code

ORDER BY s.registration_no, c.course_code;
