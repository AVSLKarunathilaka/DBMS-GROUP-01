CREATE OR REPLACE VIEW SGPAView AS
SELECT
    s.registration_no AS student_registration,
    b.academic_year,
    c.semester AS semester_name,
    CASE
        WHEN EXISTS (
            SELECT 1
            FROM StudentGrades sg2
            JOIN Course c2 ON sg2.course_code = c2.course_code
            WHERE sg2.student_registration = s.registration_no
              AND c2.semester = c.semester
              AND b.academic_year = sg2.academic_year
              AND sg2.grade = 'WH'
        ) THEN 'WH'
        WHEN EXISTS (
            SELECT 1
            FROM StudentGrades sg2
            JOIN Course c2 ON sg2.course_code = c2.course_code
            WHERE sg2.student_registration = s.registration_no
              AND c2.semester = c.semester
              AND b.academic_year = sg2.academic_year
              AND sg2.grade = 'MC'
        ) THEN 'MC'
        ELSE CAST(ROUND(
            SUM(CASE WHEN sg.grade NOT IN ('WH', 'MC', 'Ineligible') THEN sg.grade_point * c.credits ELSE 0 END) 
            / 
            SUM(CASE WHEN sg.grade NOT IN ('WH', 'MC', 'Ineligible') THEN c.credits ELSE 0 END),
            2
        ) AS CHAR)
    END AS sgpa
FROM StudentGrades sg
JOIN Student s 
    ON sg.student_registration = s.registration_no
    AND s.status = 'proper'       
JOIN Batch b 
    ON s.batch_id = b.batch_id
JOIN Course c 
    ON sg.course_code = c.course_code
GROUP BY s.registration_no, b.academic_year, c.semester
ORDER BY s.registration_no, b.academic_year, c.semester;
