CREATE OR REPLACE VIEW ExamEligibility AS
SELECT
    s.registration_no,
    CONCAT(u.first_name,' ',u.last_name) AS student_name,
    fm.course_code,
    c.name AS course_name,
    
    -- CA total
    ROUND(ca.ca_total,2) AS ca_marks,
    
    -- Eligibility check
    CASE
        WHEN s.status = 'repeat' AND ca.ca_total >= 20 THEN 'Eligible'
        WHEN s.status <> 'repeat' AND a.attendance_percentage >= 80 AND ca.ca_total >= 20 THEN 'Eligible'
        ELSE 'Not Eligible'
    END AS eligibility_status

FROM Student s
JOIN User u ON s.user_id = u.user_id
JOIN final_mark fm ON fm.registration_no = s.registration_no
JOIN Course c ON fm.course_code = c.course_code

-- Join per-student attendance view
LEFT JOIN eligibleattendanceview a
    ON a.course_code = fm.course_code
   AND a.registration_no = s.registration_no

-- Join CA marks view
LEFT JOIN CAView ca
    ON ca.course_code = fm.course_code
   AND ca.student_id = s.user_id

ORDER BY s.registration_no, fm.course_code;
mekath dann oy